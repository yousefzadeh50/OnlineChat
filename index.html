<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>کلاس آنلاین</title>
    <style>
        :root {
            --primary-color: #4a6fa5;
            --secondary-color: #6b8cbc;
            --background-color: #f5f7fa;
            --text-color: #333;
            --message-sent: #e3f2fd;
            --message-received: #ffffff;
            --border-color: #ddd;
            --success: #4CAF50;
            --warning: #ff9800;
            --error: #f44336;
            --teacher-color: #8e44ad;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: var(--background-color);
            color: var(--text-color);
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        /* مدال ثبت اطلاعات کاربر */
        .user-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .modal-content {
            background-color: rgba(255, 255, 255, 0.95);
            padding: 2rem;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            backdrop-filter: blur(10px);
        }
        
        .modal-content h2 {
            margin-bottom: 1.5rem;
            text-align: center;
            color: #2575fc;
        }
        
        .form-group {
            margin-bottom: 1rem;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: bold;
            color: #333;
        }
        
        .form-group input, .form-group select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            font-size: 1rem;
        }
        
        .submit-btn {
            width: 100%;
            padding: 0.75rem;
            background: linear-gradient(to right, #6a11cb, #2575fc);
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 1rem;
            cursor: pointer;
            margin-top: 1rem;
            transition: all 0.3s;
        }
        
        .submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .designer-section {
            position: absolute;
            bottom: 20px;
            left: 0;
            width: 100%;
            text-align: center;
            color: white;
        }
        
        .designer-photo {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            margin: 0 auto 10px;
            border: 3px solid white;
            overflow: hidden;
        }
        
        .designer-photo img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .designer-name {
            font-size: 0.9rem;
            font-weight: 300;
            letter-spacing: 1px;
        }
        
        /* استایل‌های اصلی */
        header {
            background-color: var(--primary-color);
            color: white;
            padding: 1rem;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .user-badge {
            background-color: white;
            color: var(--primary-color);
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-weight: bold;
            font-size: 0.9rem;
        }
        
        .teacher-badge {
            background-color: var(--teacher-color);
            color: white;
        }
        
        .container {
            display: flex;
            flex: 1;
            overflow: hidden;
        }
        
        .users-panel {
            width: 300px;
            background-color: white;
            border-left: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
        }
        
        .attendance-section {
            padding: 1rem;
            border-bottom: 1px solid var(--border-color);
        }
        
        .attendance-list {
            flex: 1;
            overflow-y: auto;
            padding: 0.5rem;
        }
        
        .attendance-item {
            display: flex;
            justify-content: space-between;
            padding: 0.75rem;
            border-bottom: 1px solid var(--border-color);
            font-size: 0.9rem;
        }
        
        .attendance-name {
            font-weight: bold;
        }
        
        .attendance-time {
            color: #666;
            font-size: 0.8rem;
        }
        
        .teacher-controls {
            padding: 1rem;
            border-top: 1px solid var(--border-color);
        }
        
        .teacher-btn {
            width: 100%;
            padding: 0.75rem;
            background-color: var(--teacher-color);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-bottom: 0.5rem;
        }
        
        .pending-users {
            margin-top: 1rem;
            padding: 1rem;
            border-top: 1px solid var(--border-color);
        }
        
        .pending-user {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem;
            margin-bottom: 0.5rem;
            background-color: #fff3cd;
            border-radius: 5px;
        }
        
        .approve-btn {
            background-color: var(--success);
            color: white;
            border: none;
            padding: 0.25rem 0.5rem;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.8rem;
        }
        
        .reject-btn {
            background-color: var(--error);
            color: white;
            border: none;
            padding: 0.25rem 0.5rem;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.8rem;
            margin-right: 0.25rem;
        }
        
        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        
        .messages {
            flex: 1;
            padding: 1rem;
            overflow-y: auto;
            background-color: var(--background-color);
        }
        
        .message {
            margin-bottom: 1rem;
            padding: 0.75rem;
            border-radius: 10px;
            max-width: 70%;
            position: relative;
        }
        
        .sent {
            background-color: var(--message-sent);
            margin-left: auto;
            margin-right: 0;
        }
        
        .received {
            background-color: var(--message-received);
            margin-right: auto;
            margin-left: 0;
            border: 1px solid var(--border-color);
        }
        
        .system {
            background-color: #fff3cd;
            margin: 0.5rem auto;
            text-align: center;
            max-width: 90%;
            border: 1px solid #ffeaa7;
        }
        
        .message-sender {
            font-weight: bold;
            margin-bottom: 0.25rem;
            font-size: 0.9rem;
        }
        
        .teacher-message .message-sender {
            color: var(--teacher-color);
        }
        
        .student-1 .message-text {
            color: #e74c3c;
        }
        
        .student-2 .message-text {
            color: #3498db;
        }
        
        .student-3 .message-text {
            color: #2ecc71;
        }
        
        .student-4 .message-text {
            color: #9b59b6;
        }
        
        .student-5 .message-text {
            color: #e67e22;
        }
        
        .message-time {
            font-size: 0.7rem;
            color: #777;
            text-align: left;
            margin-top: 0.25rem;
        }
        
        .input-area {
            display: flex;
            padding: 1rem;
            background-color: white;
            border-top: 1px solid var(--border-color);
        }
        
        .message-input {
            flex: 1;
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: 25px;
            margin-left: 0.5rem;
            outline: none;
        }
        
        .send-button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 50%;
            width: 45px;
            height: 45px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .audio-controls {
            display: flex;
            padding: 1rem;
            background-color: white;
            border-top: 1px solid var(--border-color);
            justify-content: center;
            gap: 1rem;
        }
        
        .audio-button {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.3s;
        }
        
        .join-button {
            background-color: var(--success);
            color: white;
        }
        
        .join-button:hover {
            background-color: #45a049;
        }
        
        .mute-button {
            background-color: var(--warning);
            color: white;
        }
        
        .mute-button:hover {
            background-color: #e68900;
        }
        
        .mute-button.muted {
            background-color: var(--error);
        }
        
        .leave-button {
            background-color: var(--error);
            color: white;
        }
        
        .leave-button:hover {
            background-color: #da190b;
        }
        
        .user-item {
            display: flex;
            align-items: center;
            padding: 0.5rem;
            border-bottom: 1px solid var(--border-color);
        }
        
        .user-avatar {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            background-color: var(--secondary-color);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            margin-left: 0.5rem;
            font-weight: bold;
        }
        
        .teacher-avatar {
            background-color: var(--teacher-color);
        }
        
        .user-name {
            font-weight: bold;
        }
        
        .user-status {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: auto;
        }
        
        .online {
            background-color: var(--success);
        }
        
        .speaking {
            background-color: var(--warning);
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }
        
        .invite-section {
            padding: 1rem;
            background-color: white;
            border-top: 1px solid var(--border-color);
        }
        
        .invite-link {
            display: flex;
            margin-top: 0.5rem;
        }
        
        .link-input {
            flex: 1;
            padding: 0.5rem;
            border: 1px solid var(--border-color);
            border-radius: 4px 0 0 4px;
            direction: ltr;
        }
        
        .copy-button {
            padding: 0.5rem 1rem;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 0 4px 4px 0;
            cursor: pointer;
        }
        
        .notification {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 1rem 2rem;
            background-color: var(--success);
            color: white;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 1000;
            display: none;
        }
        
        .hidden {
            display: none;
        }
        
        .global-designer {
            position: fixed;
            bottom: 10px;
            left: 10px;
            display: flex;
            align-items: center;
            background-color: rgba(255, 255, 255, 0.9);
            padding: 5px 10px;
            border-radius: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            z-index: 100;
        }
        
        .global-designer-photo {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            margin-left: 5px;
            overflow: hidden;
        }
        
        .global-designer-photo img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .global-designer-name {
            font-size: 0.7rem;
            color: #333;
            font-weight: 500;
        }
        
        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }
            
            .users-panel {
                width: 100%;
                height: 200px;
                border-left: none;
                border-top: 1px solid var(--border-color);
            }
            
            .message {
                max-width: 85%;
            }
        }
    </style>
</head>
<body>
    <div class="user-modal" id="userModal">
        <div class="modal-content">
            <h2>ورود به کلاس آنلاین</h2>
            <form id="userForm">
                <div class="form-group">
                    <label for="userName">نام و نام خانوادگی</label>
                    <input type="text" id="userName" required>
                </div>
                <div class="form-group">
                    <label for="userRole">نقش</label>
                    <select id="userRole" required>
                        <option value="">انتخاب کنید</option>
                        <option value="student">دانش‌آموز</option>
                        <option value="teacher">استاد</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="studentId">شماره دانش‌آموزی (اختیاری)</label>
                    <input type="text" id="studentId">
                </div>
                <button type="submit" class="submit-btn">ورود به کلاس</button>
            </form>
        </div>
        
        <div class="designer-section">
            <div class="designer-photo">
                <img src="https://s34.picofile.com/file/8488183492/2.png" alt="Designer">
            </div>
            <div class="designer-name">Designer A.R. Yousefzadeh</div>
        </div>
    </div>
    
    <div class="global-designer">
        <div class="global-designer-photo">
            <img src="https://s34.picofile.com/file/8488183492/2.png" alt="Designer">
        </div>
        <div class="global-designer-name">A.R. Yousefzadeh</div>
    </div>
    
    <div class="notification" id="notification">لینک کپی شد!</div>
    
    <header>
        <h1>کلاس آنلاین</h1>
        <div class="user-info">
            <div class="user-badge" id="userBadge">نام کاربر</div>
            <div id="connectionStatus">آنلاین</div>
        </div>
    </header>
    
    <div class="container">
        <div class="chat-area">
            <div class="messages" id="messages">
                <div class="message system">
                    <div class="message-text">به کلاس آنلاین خوش آمدید! برای شروع، به صدا بپیوندید.</div>
                    <div class="message-time" id="currentTime">هم اکنون</div>
                </div>
            </div>
            
            <div class="input-area">
                <input type="text" class="message-input" id="messageInput" placeholder="پیام خود را اینجا تایپ کنید...">
                <button class="send-button" id="sendButton">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="22" y1="2" x2="11" y2="13"></line>
                        <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                    </svg>
                </button>
            </div>
            
            <div class="audio-controls">
                <button class="audio-button join-button" id="joinAudio">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path>
                        <path d="M19 10v2a7 7 0 0 1-14 0v-2"></path>
                        <line x1="12" y1="19" x2="12" y2="23"></line>
                        <line x1="8" y1="23" x2="16" y2="23"></line>
                    </svg>
                    پیوستن به صدا
                </button>
                <button class="audio-button mute-button" id="muteButton" disabled>
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M11 5L6 9H2v6h4l5 4V5z"></path>
                    </svg>
                    قطع صدا
                </button>
                <button class="audio-button leave-button" id="leaveAudio" disabled>
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                        <polyline points="16 17 21 12 16 7"></polyline>
                        <line x1="21" y1="12" x2="9" y2="12"></line>
                    </svg>
                    ترک صدا
                </button>
            </div>
            
            <div class="invite-section hidden" id="inviteSection">
                <p>برای دعوت دیگران از لینک زیر استفاده کنید:</p>
                <div class="invite-link">
                    <input type="text" class="link-input" id="inviteLink" readonly>
                    <button class="copy-button" id="copyLink">کپی</button>
                </div>
                <div style="margin-top: 10px;">
                    <label>
                        <input type="checkbox" id="autoApproveCheckbox">
                        اجازه ورود خودکار برای همه کاربران
                    </label>
                </div>
            </div>
        </div>
        
        <div class="users-panel">
            <div class="attendance-section">
                <h3>حاضرین در کلاس (<span id="userCount">0</span>)</h3>
                <div class="attendance-list" id="attendanceList">
                    <!-- لیست حاضرین اینجا نمایش داده می‌شود -->
                </div>
            </div>
            
            <div class="pending-users hidden" id="pendingUsersSection">
                <h4>کاربران در انتظار تایید</h4>
                <div id="pendingUsersList">
                    <!-- لیست کاربران در انتظار تایید -->
                </div>
            </div>
            
            <div class="teacher-controls hidden" id="teacherControls">
                <button class="teacher-btn" id="viewAttendance">مشاهده گزارش حضور و غیاب</button>
                <button class="teacher-btn" id="downloadAttendance">دانلود گزارش</button>
            </div>
        </div>
    </div>

    <script>
        // مدیریت کلاس آنلاین
        class OnlineClass {
            constructor() {
                this.currentUser = null;
                this.attendance = [];
                this.users = new Map();
                this.pendingUsers = [];
                this.isTeacher = false;
                this.localStream = null;
                this.isJoined = false;
                this.isMuted = false;
                this.autoApprove = false;
                this.roomId = this.getRoomIdFromURL();
                this.studentColors = {};
                
                this.init();
            }
            
            init() {
                this.setupEventListeners();
                this.generateInviteLink();
                this.updateTime();
                
                // به روز رسانی زمان هر ثانیه
                setInterval(() => this.updateTime(), 1000);
            }
            
            getRoomIdFromURL() {
                const urlParams = new URLSearchParams(window.location.search);
                return urlParams.get('room') || 'class-' + Math.random().toString(36).substr(2, 5);
            }
            
            setupEventListeners() {
                // فرم ثبت اطلاعات کاربر
                document.getElementById('userForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.registerUser();
                });
                
                // مدیریت پیام‌ها
                document.getElementById('sendButton').addEventListener('click', () => this.sendMessage());
                document.getElementById('messageInput').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') this.sendMessage();
                });
                
                // مدیریت صدا
                document.getElementById('joinAudio').addEventListener('click', () => this.joinAudio());
                document.getElementById('muteButton').addEventListener('click', () => this.toggleMute());
                document.getElementById('leaveAudio').addEventListener('click', () => this.leaveAudio());
                
                // مدیریت لینک دعوت
                document.getElementById('copyLink').addEventListener('click', () => this.copyInviteLink());
                
                // کنترل‌های استاد
                document.getElementById('viewAttendance').addEventListener('click', () => this.viewAttendanceReport());
                document.getElementById('downloadAttendance').addEventListener('click', () => this.downloadAttendanceReport());
                
                // چک باکس تایید خودکار
                document.getElementById('autoApproveCheckbox').addEventListener('change', (e) => {
                    this.autoApprove = e.target.checked;
                });
            }
            
            registerUser() {
                const userName = document.getElementById('userName').value;
                const userRole = document.getElementById('userRole').value;
                const studentId = document.getElementById('studentId').value;
                
                this.currentUser = {
                    id: this.generateUserId(),
                    name: userName,
                    role: userRole,
                    studentId: studentId,
                    joinTime: new Date(),
                    leaveTime: null,
                    approved: userRole === 'teacher' // استادان به طور خودکار تایید می‌شوند
                };
                
                this.isTeacher = userRole === 'teacher';
                
                if (this.isTeacher) {
                    // اگر کاربر استاد است، مستقیماً وارد شود
                    this.approveUser(this.currentUser);
                } else {
                    // اگر کاربر دانش‌آموز است، در لیست انتظار قرار گیرد
                    this.addPendingUser(this.currentUser);
                    document.getElementById('userModal').style.display = 'none';
                    this.showNotification('در انتظار تایید استاد...');
                    return;
                }
                
                // مخفی کردن مدال
                document.getElementById('userModal').style.display = 'none';
                
                // به روز رسانی اطلاعات کاربر
                this.updateUserInfo();
                
                // نمایش کنترل‌های استاد اگر کاربر استاد باشد
                if (this.isTeacher) {
                    document.getElementById('teacherControls').classList.remove('hidden');
                    document.getElementById('inviteSection').classList.remove('hidden');
                    document.getElementById('userBadge').classList.add('teacher-badge');
                    document.getElementById('userBadge').textContent = `استاد: ${userName}`;
                } else {
                    document.getElementById('userBadge').textContent = `دانش‌آموز: ${userName}`;
                }
                
                // پیام خوش‌آمدگویی
                this.addSystemMessage(`${userName} به کلاس پیوست.`);
            }
            
            addPendingUser(user) {
                this.pendingUsers.push(user);
                this.updatePendingUsersList();
                
                // اطلاع به استاد
                if (this.isTeacher) {
                    this.addSystemMessage(`دانش‌آموز ${user.name} در انتظار تایید است.`);
                }
            }
            
            updatePendingUsersList() {
                const pendingUsersList = document.getElementById('pendingUsersList');
                const pendingUsersSection = document.getElementById('pendingUsersSection');
                
                if (this.pendingUsers.length > 0 && this.isTeacher) {
                    pendingUsersSection.classList.remove('hidden');
                } else {
                    pendingUsersSection.classList.add('hidden');
                }
                
                pendingUsersList.innerHTML = '';
                
                this.pendingUsers.forEach(user => {
                    const pendingUserElement = document.createElement('div');
                    pendingUserElement.className = 'pending-user';
                    pendingUserElement.innerHTML = `
                        <div>${user.name}</div>
                        <div>
                            <button class="reject-btn" data-userid="${user.id}">رد</button>
                            <button class="approve-btn" data-userid="${user.id}">تایید</button>
                        </div>
                    `;
                    
                    pendingUsersList.appendChild(pendingUserElement);
                });
                
                // اضافه کردن event listener برای دکمه‌های تایید و رد
                document.querySelectorAll('.approve-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const userId = e.target.getAttribute('data-userid');
                        this.approveUserById(userId);
                    });
                });
                
                document.querySelectorAll('.reject-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const userId = e.target.getAttribute('data-userid');
                        this.rejectUserById(userId);
                    });
                });
            }
            
            approveUserById(userId) {
                const userIndex = this.pendingUsers.findIndex(user => user.id === userId);
                if (userIndex !== -1) {
                    const user = this.pendingUsers[userIndex];
                    this.pendingUsers.splice(userIndex, 1);
                    this.approveUser(user);
                    this.updatePendingUsersList();
                }
            }
            
            rejectUserById(userId) {
                const userIndex = this.pendingUsers.findIndex(user => user.id === userId);
                if (userIndex !== -1) {
                    const user = this.pendingUsers[userIndex];
                    this.pendingUsers.splice(userIndex, 1);
                    this.addSystemMessage(`درخواست ${user.name} رد شد.`);
                    this.updatePendingUsersList();
                }
            }
            
            approveUser(user) {
                user.approved = true;
                this.recordAttendance(user, 'join');
                this.addSystemMessage(`${user.name} به کلاس پیوست.`);
                
                // اختصاص رنگ به دانش‌آموز
                if (user.role === 'student') {
                    this.assignColorToStudent(user.id);
                }
            }
            
            assignColorToStudent(studentId) {
                const colors = ['student-1', 'student-2', 'student-3', 'student-4', 'student-5'];
                const usedColors = Object.values(this.studentColors);
                const availableColors = colors.filter(color => !usedColors.includes(color));
                
                if (availableColors.length > 0) {
                    this.studentColors[studentId] = availableColors[0];
                } else {
                    // اگر همه رنگ‌ها استفاده شده‌اند، از اول شروع کنیم
                    this.studentColors[studentId] = colors[Math.floor(Math.random() * colors.length)];
                }
            }
            
            generateUserId() {
                return 'user-' + Math.random().toString(36).substr(2, 9);
            }
            
            recordAttendance(user, action) {
                const record = {
                    userId: user.id,
                    userName: user.name,
                    userRole: user.role,
                    studentId: user.studentId,
                    action: action,
                    timestamp: new Date(),
                    timeString: this.getTimeString()
                };
                
                this.attendance.push(record);
                this.updateAttendanceList();
                
                // ذخیره در localStorage (در نسخه واقعی باید به سرور ارسال شود)
                this.saveToLocalStorage();
            }
            
            updateAttendanceList() {
                const attendanceList = document.getElementById('attendanceList');
                const userCount = document.getElementById('userCount');
                
                // فقط ۱۰ مورد آخر را نمایش می‌دهیم
                const recentRecords = this.attendance.slice(-10).reverse();
                
                attendanceList.innerHTML = '';
                
                recentRecords.forEach(record => {
                    const item = document.createElement('div');
                    item.className = 'attendance-item';
                    
                    let actionText = '';
                    if (record.action === 'join') {
                        actionText = 'ورود';
                    } else if (record.action === 'leave') {
                        actionText = 'خروج';
                    }
                    
                    item.innerHTML = `
                        <div>
                            <div class="attendance-name">${record.userName} ${record.userRole === 'teacher' ? '(استاد)' : ''}</div>
                            <div class="attendance-time">${actionText} - ${record.timeString}</div>
                        </div>
                    `;
                    
                    attendanceList.appendChild(item);
                });
                
                // شمارش کاربران آنلاین
                const onlineUsers = this.attendance.filter(record => 
                    record.action === 'join' && 
                    !this.attendance.some(r => r.userId === record.userId && r.action === 'leave' && r.timestamp > record.timestamp)
                );
                
                userCount.textContent = onlineUsers.length;
            }
            
            updateUserInfo() {
                document.getElementById('userBadge').textContent = 
                    this.isTeacher ? `استاد: ${this.currentUser.name}` : `دانش‌آموز: ${this.currentUser.name}`;
            }
            
            updateTime() {
                const now = new Date();
                const timeString = `${now.getHours()}:${now.getMinutes().toString().padStart(2, '0')}:${now.getSeconds().toString().padStart(2, '0')}`;
                document.getElementById('currentTime').textContent = timeString;
            }
            
            getTimeString() {
                const now = new Date();
                return `${now.getHours()}:${now.getMinutes().toString().padStart(2, '0')}:${now.getSeconds().toString().padStart(2, '0')}`;
            }
            
            generateInviteLink() {
                const currentUrl = window.location.origin + window.location.pathname + '?room=' + this.roomId;
                document.getElementById('inviteLink').value = currentUrl;
            }
            
            async joinAudio() {
                try {
                    // درخواست دسترسی به میکروفون
                    this.localStream = await navigator.mediaDevices.getUserMedia({ 
                        audio: {
                            echoCancellation: true,
                            noiseSuppression: true,
                            autoGainControl: true
                        } 
                    });
                    
                    this.isJoined = true;
                    this.updateAudioUI();
                    this.addSystemMessage('شما به گفتگوی صوتی پیوستید.');
                    
                } catch (error) {
                    console.error('خطا در دسترسی به میکروفون:', error);
                    this.addSystemMessage('خطا در دسترسی به میکروفون. لطفا مجوزها را بررسی کنید.', 'error');
                }
            }
            
            toggleMute() {
                if (!this.localStream) return;
                
                this.isMuted = !this.isMuted;
                const audioTracks = this.localStream.getAudioTracks();
                audioTracks.forEach(track => {
                    track.enabled = !this.isMuted;
                });
                
                const muteButton = document.getElementById('muteButton');
                if (this.isMuted) {
                    muteButton.innerHTML = `
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <line x1="1" y1="1" x2="23" y2="23"></line>
                            <path d="M9 9v3a3 3 0 0 0 5.12 2.12M15 9.34V4a3 3 0 0 0-5.94-.6"></path>
                            <path d="M17 16.95A7 7 0 0 1 5 12v-2m14 0v2a7 7 0 0 1-.11 1.23"></path>
                            <line x1="12" y1="19" x2="12" y2="23"></line>
                            <line x1="8" y1="23" x2="16" y2="23"></line>
                        </svg>
                        فعال کردن صدا
                    `;
                    muteButton.classList.add('muted');
                    this.addSystemMessage('میکروفون شما قطع شد.');
                } else {
                    muteButton.innerHTML = `
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M11 5L6 9H2v6h4l5 4V5z"></path>
                        </svg>
                        قطع صدا
                    `;
                    muteButton.classList.remove('muted');
                    this.addSystemMessage('میکروفون شما فعال شد.');
                }
            }
            
            leaveAudio() {
                if (this.localStream) {
                    this.localStream.getTracks().forEach(track => track.stop());
                    this.localStream = null;
                }
                
                this.isJoined = false;
                this.isMuted = false;
                this.updateAudioUI();
                this.addSystemMessage('شما از گفتگوی صوتی خارج شدید.');
            }
            
            updateAudioUI() {
                document.getElementById('joinAudio').disabled = this.isJoined;
                document.getElementById('muteButton').disabled = !this.isJoined;
                document.getElementById('leaveAudio').disabled = !this.isJoined;
            }
            
            sendMessage() {
                // اگر کاربر تایید نشده است، نمی‌تواند پیام بفرستد
                if (this.currentUser && !this.currentUser.approved) {
                    this.showNotification('شما هنوز تایید نشده‌اید. لطفا منتظر بمانید.');
                    return;
                }
                
                const messageInput = document.getElementById('messageInput');
                const messageText = messageInput.value.trim();
                
                if (messageText) {
                    const studentColorClass = this.studentColors[this.currentUser.id] || '';
                    this.addMessage(messageText, this.currentUser.name, true, this.isTeacher, studentColorClass);
                    messageInput.value = '';
                    
                    // شبیه‌سازی پاسخ سایر کاربران
                    this.simulateReply(messageText);
                }
            }
            
            addMessage(text, sender, isSent = false, isTeacher = false, colorClass = '') {
                const messagesContainer = document.getElementById('messages');
                const messageElement = document.createElement('div');
                messageElement.className = `message ${isSent ? 'sent' : 'received'} ${isTeacher ? 'teacher-message' : ''} ${colorClass}`;
                
                const now = new Date();
                const timeString = `${now.getHours()}:${now.getMinutes().toString().padStart(2, '0')}`;
                
                messageElement.innerHTML = `
                    <div class="message-sender">${sender} ${isTeacher ? '(استاد)' : ''}</div>
                    <div class="message-text">${text}</div>
                    <div class="message-time">${timeString}</div>
                `;
                
                messagesContainer.appendChild(messageElement);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }
            
            addSystemMessage(text, type = 'info') {
                const messagesContainer = document.getElementById('messages');
                const messageElement = document.createElement('div');
                messageElement.className = 'message system';
                
                if (type === 'error') {
                    messageElement.style.backgroundColor = '#f8d7da';
                    messageElement.style.borderColor = '#f5c6cb';
                }
                
                const now = new Date();
                const timeString = `${now.getHours()}:${now.getMinutes().toString().padStart(2, '0')}`;
                
                messageElement.innerHTML = `
                    <div class="message-text">${text}</div>
                    <div class="message-time">${timeString}</div>
                `;
                
                messagesContainer.appendChild(messageElement);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }
            
            simulateReply(originalMessage) {
                setTimeout(() => {
                    // فقط اگر کاربر استاد نباشد پاسخ شبیه‌سازی می‌شود
                    if (!this.isTeacher) {
                        const replies = this.generateReplies(originalMessage);
                        const randomReply = replies[Math.floor(Math.random() * replies.length)];
                        
                        // شبیه‌سازی پاسخ از سوی استاد
                        this.addMessage(randomReply, 'استاد احمدی', false, true);
                    }
                }, 1000 + Math.random() * 3000);
            }
            
            generateReplies(message) {
                const lowerMessage = message.toLowerCase();
                
                if (lowerMessage.includes('سوال') || lowerMessage.includes('؟')) {
                    return [
                        'سوال خوبیه، بذارید بیشتر توضیح بدم...',
                        'برای پاسخ به این سوال باید فصل ۳ رو مرور کنیم',
                        'کسی دیگه هم این سوال رو داره؟',
                        'فردا بیشتر در مورد این موضوع صحبت می‌کنیم'
                    ];
                } else if (lowerMessage.includes('تکلیف') || lowerMessage.includes('تمرین')) {
                    return [
                        'تکلیف فردا تا ساعت ۱۰ صبح باید تحویل داده بشه',
                        'برای تمرین این هفته، مسئله‌های صفحه ۴۵ رو حل کنید',
                        'اگر در انجام تمرین مشکل دارید، می‌تونید از هم کمک بگیرید',
                        'تمرین‌ها رو به ایمیل من ارسال کنید'
                    ];
                } else {
                    return [
                        'ممنون از مشارکت شما',
                        'نظر جالبی بود',
                        'این موضوع رو در جلسه آینده بیشتر بررسی می‌کنیم',
                        'اگر سوال دیگه‌ای دارید بپرسید'
                    ];
                }
            }
            
            copyInviteLink() {
                const inviteLink = document.getElementById('inviteLink');
                inviteLink.select();
                inviteLink.setSelectionRange(0, 99999);
                
                try {
                    navigator.clipboard.writeText(inviteLink.value).then(() => {
                        this.showNotification('لینک با موفقیت کپی شد!');
                    });
                } catch (err) {
                    // Fallback for older browsers
                    document.execCommand('copy');
                    this.showNotification('لینک کپی شد!');
                }
            }
            
            viewAttendanceReport() {
                if (!this.isTeacher) return;
                
                let report = 'گزارش حضور و غیاب کلاس\n';
                report += 'تاریخ: ' + new Date().toLocaleDateString('fa-IR') + '\n\n';
                
                report += 'نام\tنقش\tشماره دانش‌آموزی\tزمان ورود\tزمان خروج\tمدت حضور\n';
                
                this.attendance.forEach(record => {
                    report += `${record.userName}\t${record.userRole === 'teacher' ? 'استاد' : 'دانش‌آموز'}\t${record.studentId || '-'}\t${record.timeString}\t${record.action === 'leave' ? record.timeString : 'هنوز در کلاس'}\t-\n`;
                });
                
                alert(report);
            }
            
            downloadAttendanceReport() {
                if (!this.isTeacher) return;
                
                let csv = 'نام,نقش,شماره دانش‌آموزی,زمان ورود,زمان خروج,مدت حضور\n';
                
                this.attendance.forEach(record => {
                    csv += `"${record.userName}","${record.userRole === 'teacher' ? 'استاد' : 'دانش‌آموز'}","${record.studentId || '-'}","${record.timeString}","${record.action === 'leave' ? record.timeString : 'هنوز در کلاس'}","-"\n`;
                });
                
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.setAttribute('href', url);
                link.setAttribute('download', `attendance-${new Date().toISOString().split('T')[0]}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
            
            saveToLocalStorage() {
                localStorage.setItem(`attendance-${this.roomId}`, JSON.stringify(this.attendance));
            }
            
            loadFromLocalStorage() {
                const saved = localStorage.getItem(`attendance-${this.roomId}`);
                if (saved) {
                    this.attendance = JSON.parse(saved);
                    this.updateAttendanceList();
                }
            }
            
            showNotification(message) {
                const notification = document.getElementById('notification');
                notification.textContent = message;
                notification.style.display = 'block';
                
                setTimeout(() => {
                    notification.style.display = 'none';
                }, 3000);
            }
        }

        // راه‌اندازی برنامه
        document.addEventListener('DOMContentLoaded', () => {
            window.onlineClass = new OnlineClass();
            
            // ثبت خروج کاربر هنگام بستن صفحه
            window.addEventListener('beforeunload', () => {
                if (window.onlineClass.currentUser) {
                    window.onlineClass.recordAttendance(window.onlineClass.currentUser, 'leave');
                }
            });
        });
    </script>
</body>
</html>
